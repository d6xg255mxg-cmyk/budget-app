<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê³„ë¶€</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .header {
            background: white;
            color: #333;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #212529;
        }

        .month-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .month-selector button {
            background: white;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .month-selector button:hover {
            background: #f8f9fa;
        }

        .month-selector span {
            font-weight: 600;
            font-size: 18px;
            min-width: 150px;
            color: #212529;
        }

        .balance-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #e9ecef;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 18px;
            color: #495057;
        }

        .balance-item.total {
            border-top: 2px solid #dee2e6;
            padding-top: 15px;
            margin-top: 15px;
            font-weight: bold;
            font-size: 24px;
            color: #212529;
        }

        .balance-item.crypto {
            color: #6c757d;
            font-size: 16px;
            font-style: italic;
        }

        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: white;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .tab.active {
            background: white;
            color: #212529;
            border-bottom: 2px solid #212529;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: white;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #495057;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        .input-row .input-group {
            flex: 1;
        }

        .btn {
            background: #212529;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #343a40;
        }

        .btn:active {
            background: #1a1e21;
        }

        .btn-delete {
            background: #6c757d;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-delete:hover {
            background: #5a6268;
        }

        .btn-edit {
            background: #495057;
            padding: 8px 16px;
            font-size: 14px;
            margin-right: 5px;
        }

        .btn-edit:hover {
            background: #343a40;
        }

        .list {
            margin-top: 30px;
        }

        .list-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
            border: 1px solid #e9ecef;
            cursor: move;
        }

        .list-item:hover {
            background: #f8f9fa;
        }

        .list-item.dragging {
            opacity: 0.5;
            background: #e9ecef;
        }

        .list-item.drag-over {
            border-top: 3px solid #495057;
        }

        .drag-handle {
            cursor: grab;
            color: #adb5bd;
            font-size: 20px;
            margin-right: 10px;
            user-select: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .list-item-info {
            flex: 1;
        }

        .list-item-name {
            font-weight: 600;
            font-size: 16px;
            color: #212529;
            margin-bottom: 5px;
        }

        .list-item-detail {
            font-size: 14px;
            color: #6c757d;
        }

        .payment-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .payment-badge.regular {
            background: #e9ecef;
            color: #495057;
        }

        .payment-badge.crypto {
            background: #fff3cd;
            color: #856404;
        }

        .payment-badge.income {
            background: #d4edda;
            color: #155724;
        }

        .list-item.income {
            border-left: 4px solid #28a745;
        }

        .list-item-amount.income {
            color: #28a745;
        }

        .balance-item.income {
            color: #28a745;
        }

        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .category-selector {
            margin-top: 10px;
        }

        .category-selector select {
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
            background: white;
            cursor: pointer;
        }

        .category-stats-item {
            margin-bottom: 20px;
            cursor: pointer;
            padding: 10px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .category-stats-item:hover {
            background: #f8f9fa;
        }

        .list-item-amount {
            font-size: 20px;
            font-weight: bold;
            color: #212529;
            margin-right: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #adb5bd;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .salary-input {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 30px;
        }

        .salary-input h3 {
            margin-bottom: 15px;
            font-size: 20px;
            color: #212529;
        }

        .salary-input input {
            background: white;
        }

        .calendar-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header h3 {
            margin: 0;
            color: #212529;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .calendar-nav button {
            background: white;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .calendar-nav button:hover {
            background: #e9ecef;
        }

        .calendar-month {
            font-weight: 600;
            color: #212529;
            min-width: 120px;
            text-align: center;
        }

        .monthly-summary {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }

        .monthly-summary-title {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .monthly-summary-items {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .monthly-summary-item {
            flex: 1;
            min-width: 150px;
        }

        .monthly-summary-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .monthly-summary-value {
            font-size: 20px;
            font-weight: bold;
            color: #212529;
        }

        .monthly-summary-value.crypto {
            color: #6c757d;
        }

        .calendar {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .calendar-weekday {
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: #495057;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day {
            min-height: 80px;
            padding: 8px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            background: #fafafa;
            color: #adb5bd;
        }

        .calendar-day.today {
            background: #fff9e6;
        }

        .calendar-day-number {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 4px;
        }

        .calendar-day.other-month .calendar-day-number {
            color: #adb5bd;
        }

        .calendar-day-expense {
            font-size: 12px;
            color: #495057;
            font-weight: 600;
            margin-top: 4px;
        }

        .calendar-day-items {
            font-size: 11px;
            color: #6c757d;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 4px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .view-toggle button {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: white;
            color: #212529;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .data-management {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }

        .data-management h3 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #212529;
        }

        .data-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-secondary {
            background: white;
            color: #212529;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
        }

        #importFile {
            display: none;
        }

        .image-upload-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }

        .image-upload-section h3 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #212529;
        }

        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #495057;
            background: #f8f9fa;
        }

        .upload-area.dragover {
            border-color: #212529;
            background: #e9ecef;
        }

        #imageFile {
            display: none;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            margin-top: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #212529;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #212529;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: #f8f9fa;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-expense-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-expense-item:last-child {
            border-bottom: none;
        }

        .modal-expense-info {
            flex: 1;
        }

        .modal-expense-name {
            font-weight: 600;
            color: #212529;
            margin-bottom: 5px;
        }

        .modal-expense-amount {
            font-size: 18px;
            font-weight: bold;
            color: #212529;
        }

        .modal-total {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 18px;
        }

        .modal-empty {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .edit-form {
            padding: 20px;
        }

        .edit-form .input-group {
            margin-bottom: 15px;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 15px 20px;
            border-top: 1px solid #e9ecef;
        }

        .btn-cancel {
            background: #e9ecef;
            color: #495057;
        }

        .btn-cancel:hover {
            background: #dee2e6;
        }

        @media (max-width: 600px) {
            .input-row {
                flex-direction: column;
            }

            .list-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .list-item-amount {
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° ë‚˜ì˜ ê°€ê³„ë¶€</h1>
            <div class="month-selector">
                <button onclick="changeViewMonth(-1)">â—€</button>
                <span id="viewMonth"></span>
                <button onclick="changeViewMonth(1)">â–¶</button>
            </div>
            <div class="balance-summary">
                <div class="balance-item">
                    <span>ì›”ê¸‰:</span>
                    <span id="salaryDisplay">â‚¬0</span>
                </div>
                <div class="balance-item income">
                    <span>+ ê¸°íƒ€ìˆ˜ì…:</span>
                    <span id="incomeDisplay">â‚¬0</span>
                </div>
                <div class="balance-item">
                    <span>ê³ ì •ì§€ì¶œ:</span>
                    <span id="fixedExpenseDisplay">â‚¬0</span>
                </div>
                <div class="balance-item">
                    <span>ì¼ë°˜ì¹´ë“œ ì§€ì¶œ:</span>
                    <span id="dailyExpenseDisplay">â‚¬0</span>
                </div>
                <div class="balance-item crypto">
                    <span>ğŸª™ ê°€ìƒí™”íì¹´ë“œ ì§€ì¶œ:</span>
                    <span id="cryptoExpenseDisplay">â‚¬0</span>
                </div>
                <div class="balance-item total">
                    <span>í†µì¥ ë‚¨ì€ ê¸ˆì•¡:</span>
                    <span id="remainingDisplay">â‚¬0</span>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'salary')">ğŸ’µ ì›”ê¸‰</button>
            <button class="tab" onclick="switchTab(event, 'fixed')">ğŸ“Œ ê³ ì •ì§€ì¶œ</button>
            <button class="tab" onclick="switchTab(event, 'daily')">ğŸ“… ì¼ë³„ì§€ì¶œ</button>
            <button class="tab" onclick="switchTab(event, 'assets')">ğŸ’ ìì‚°</button>
            <button class="tab" onclick="switchTab(event, 'stats')">ğŸ“Š í†µê³„</button>
        </div>

        <div class="content">
            <!-- ì›”ê¸‰ íƒ­ -->
            <div id="salaryTab" class="tab-content active">
                <div class="data-management">
                    <h3>ğŸ“ ë°ì´í„° ê´€ë¦¬</h3>
                    <p style="font-size: 14px; color: #6c757d; margin-bottom: 15px;">
                        ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•˜ê±°ë‚˜ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                    <div class="data-buttons">
                        <button class="btn btn-secondary" onclick="exportData()">ğŸ’¾ ë‚´ë³´ë‚´ê¸°</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“‚ ê°€ì ¸ì˜¤ê¸°</button>
                        <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                    </div>
                </div>

                <div class="salary-input">
                    <h3>ì›”ê¸‰ ì…ë ¥</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>ì›” ì„ íƒ</label>
                            <input type="month" id="salaryMonth">
                        </div>
                        <div class="input-group">
                            <label>ê¸ˆì•¡ (â‚¬)</label>
                            <input type="number" id="salaryInput" placeholder="ì›”ê¸‰ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                    </div>
                    <button class="btn" onclick="setSalary()">ì €ì¥</button>
                </div>

                <div class="list" id="salaryList">
                    <h3 style="margin: 20px 0 15px 0; color: #333;">ì›”ë³„ ì›”ê¸‰ ë‚´ì—­</h3>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; color: #495057; border: 1px solid #e9ecef; margin-top: 20px;">
                    <h4 style="margin-bottom: 10px; color: #212529;">ğŸ’¡ ì‚¬ìš© ì•ˆë‚´</h4>
                    <p>ë§¤ë‹¬ ë‹¤ë¥¸ ì›”ê¸‰ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°€ì¥ ìµœê·¼ ì›”ê¸‰ì„ ê¸°ì¤€ìœ¼ë¡œ ë‚¨ì€ ê¸ˆì•¡ì´ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- ê³ ì •ì§€ì¶œ íƒ­ -->
            <div id="fixedTab" class="tab-content">
                <div class="image-upload-section">
                    <h3>ğŸ“¸ ì‚¬ì§„ìœ¼ë¡œ ìë™ ì…ë ¥</h3>
                    <p style="font-size: 14px; color: #6c757d; margin-bottom: 15px;">
                        ê³ ì •ì§€ì¶œ ë‚´ì—­ì´ ì íŒ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ì¸ì‹í•´ì„œ ì…ë ¥í•©ë‹ˆë‹¤.
                    </p>
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('imageFile').click()">
                        <div>ğŸ“·</div>
                        <p style="margin: 10px 0; font-weight: 600;">í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                        <p style="font-size: 14px; color: #6c757d;">PNG, JPG, JPEG í˜•ì‹ ì§€ì›</p>
                    </div>
                    <input type="file" id="imageFile" accept="image/*" onchange="handleImageUpload(event)">
                    <img id="previewImage" class="preview-image" style="display: none;">
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                    </div>
                </div>

                <h2 style="margin-bottom: 20px;">ê³ ì •ì§€ì¶œ ì¶”ê°€</h2>
                <div class="input-row">
                    <div class="input-group">
                        <label>í•­ëª©ëª…</label>
                        <input type="text" id="fixedName" placeholder="ì˜ˆ: ì›”ì„¸, í†µì‹ ë¹„, ë³´í—˜ë£Œ">
                    </div>
                    <div class="input-group">
                        <label>ê¸ˆì•¡ (â‚¬)</label>
                        <input type="number" id="fixedAmount" placeholder="ê¸ˆì•¡ ì…ë ¥">
                    </div>
                </div>
                <button class="btn" onclick="addFixedExpense()">ì¶”ê°€</button>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 10px;">
                    <h3 style="margin: 0; color: #333;">ê³ ì •ì§€ì¶œ ëª©ë¡</h3>
                    <p style="font-size: 13px; color: #6c757d; margin: 0;">ğŸ’¡ ë“œë˜ê·¸í•´ì„œ ìˆœì„œ ë³€ê²½</p>
                </div>
                
                <div class="list" id="fixedList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <p>ì•„ì§ ê³ ì •ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>

            <!-- ì¼ë³„ì§€ì¶œ íƒ­ -->
            <div id="dailyTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">ì¼ë³„ ì§€ì¶œ/ìˆ˜ì… ì¶”ê°€</h2>
                <div class="input-row">
                    <div class="input-group">
                        <label>ë‚ ì§œ</label>
                        <input type="date" id="dailyDate">
                    </div>
                    <div class="input-group">
                        <label>ìœ í˜•</label>
                        <select id="transactionType" onchange="updatePaymentMethodOptions()">
                            <option value="expense">ğŸ’¸ ì§€ì¶œ</option>
                            <option value="income">ğŸ’° ìˆ˜ì…</option>
                        </select>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>í•­ëª©ëª…</label>
                        <input type="text" id="dailyName" placeholder="ì˜ˆ: ì‹ë¹„, êµí†µë¹„, ë¹Œë ¤ì¤€ ëˆ íšŒìˆ˜">
                    </div>
                    <div class="input-group">
                        <label>ê¸ˆì•¡ (â‚¬)</label>
                        <input type="number" id="dailyAmount" placeholder="ê¸ˆì•¡ ì…ë ¥">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>ì¹´í…Œê³ ë¦¬</label>
                        <select id="categorySelect">
                            <option value="">ğŸ¤– AI ìë™ ë¶„ë¥˜</option>
                            <option value="ì‹ë¹„">ğŸ½ï¸ ì‹ë¹„</option>
                            <option value="êµí†µë¹„">ğŸš‡ êµí†µë¹„</option>
                            <option value="ì‡¼í•‘">ğŸ›ï¸ ì‡¼í•‘</option>
                            <option value="ë¬¸í™”ìƒí™œ">ğŸ¬ ë¬¸í™”ìƒí™œ</option>
                            <option value="êµ¬ë…ë£Œ">ğŸ“± êµ¬ë…ë£Œ</option>
                            <option value="ì˜ë£Œ">ğŸ¥ ì˜ë£Œ</option>
                            <option value="êµìœ¡">ğŸ“š êµìœ¡</option>
                            <option value="ê¸°íƒ€">ğŸ“¦ ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="input-group" id="paymentMethodGroupContainer">
                        <label>ê²°ì œ ìˆ˜ë‹¨</label>
                        <select id="paymentMethod">
                            <option value="regular">ğŸ’³ ì¼ë°˜ì¹´ë“œ (í†µì¥)</option>
                            <option value="crypto">ğŸª™ ê°€ìƒí™”íì¹´ë“œ</option>
                        </select>
                    </div>
                </div>
                <div class="input-row" id="accountSelectionRow">
                    <div class="input-group">
                        <label>ì¶œê¸ˆ ê³„ì¢Œ</label>
                        <select id="fromAccount">
                            <option value="">ì„ íƒ ì•ˆí•¨ (ìì‚° ë³€ë™ ì—†ìŒ)</option>
                        </select>
                    </div>
                </div>
                <div style="display: none;" id="paymentMethodGroup"></div>
                <button class="btn" onclick="addDailyExpense()">ì¶”ê°€</button>

                <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #212529;">ğŸ“ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h4>
                            <p style="margin: 0; font-size: 14px; color: #6c757d;">ë‚˜ë§Œì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="newCategoryName" placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„" style="flex: 1; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px;">
                        <input type="text" id="newCategoryEmoji" placeholder="ì´ëª¨ì§€" style="width: 80px; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px;">
                        <button class="btn" onclick="addCustomCategory()">ì¶”ê°€</button>
                    </div>
                    <div id="customCategoryList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                    </div>
                </div>

                <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #212529;">ğŸ¤– ê¸°ì¡´ ë‚´ì—­ AI ë¶„ë¥˜</h4>
                            <p style="margin: 0; font-size: 14px; color: #6c757d;">ì¹´í…Œê³ ë¦¬ê°€ "ê¸°íƒ€"ì¸ í•­ëª©ë“¤ì„ AIê°€ ìë™ìœ¼ë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤.</p>
                        </div>
                        <button class="btn" onclick="bulkClassifyExpenses(event)" style="white-space: nowrap;">ì¼ê´„ ë¶„ë¥˜</button>
                    </div>
                </div>

                <div class="view-toggle">
                    <button class="active" onclick="switchDailyView('list')">ğŸ“‹ ëª©ë¡</button>
                    <button onclick="switchDailyView('calendar')">ğŸ“… ë‹¬ë ¥</button>
                </div>

                <div id="dailyListView">
                    <!-- ì›”ë³„ ì´ ì§€ì¶œ ìš”ì•½ -->
                    <div class="monthly-summary" style="margin-bottom: 20px;">
                        <div class="monthly-summary-title">ğŸ“Š ì´ë²ˆ ë‹¬ ì´ê³„</div>
                        <div class="monthly-summary-items">
                            <div class="monthly-summary-item">
                                <div class="monthly-summary-label">ğŸ’³ ì¼ë°˜ì¹´ë“œ ì§€ì¶œ</div>
                                <div class="monthly-summary-value" id="listMonthlyRegularTotal">â‚¬0.00</div>
                            </div>
                            <div class="monthly-summary-item">
                                <div class="monthly-summary-label">ğŸª™ ê°€ìƒí™”íì¹´ë“œ ì§€ì¶œ</div>
                                <div class="monthly-summary-value crypto" id="listMonthlyCryptoTotal">â‚¬0.00</div>
                            </div>
                            <div class="monthly-summary-item">
                                <div class="monthly-summary-label">ğŸ’° ìˆ˜ì…</div>
                                <div class="monthly-summary-value" style="color: #28a745;" id="listMonthlyIncome">â‚¬0.00</div>
                            </div>
                            <div class="monthly-summary-item">
                                <div class="monthly-summary-label">ìˆœ ì§€ì¶œ</div>
                                <div class="monthly-summary-value" id="listMonthlyNet">â‚¬0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="list" id="dailyList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“…</div>
                            <p>ì•„ì§ ì¼ë³„ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>

                <div id="dailyCalendarView" style="display: none;">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <h3>ğŸ“… ì§€ì¶œ ë‹¬ë ¥</h3>
                            <div class="calendar-nav">
                                <button onclick="changeMonth(-1)">â—€</button>
                                <span class="calendar-month" id="calendarMonth"></span>
                                <button onclick="changeMonth(1)">â–¶</button>
                            </div>
                        </div>
                        
                        <!-- ì›”ë³„ ì´ ì§€ì¶œ ìš”ì•½ -->
                        <div class="monthly-summary">
                            <div class="monthly-summary-title">ğŸ“Š ì´ë²ˆ ë‹¬ ì´ê³„</div>
                            <div class="monthly-summary-items">
                                <div class="monthly-summary-item">
                                    <div class="monthly-summary-label">ğŸ’³ ì¼ë°˜ì¹´ë“œ ì§€ì¶œ</div>
                                    <div class="monthly-summary-value" id="monthlyRegularTotal">â‚¬0.00</div>
                                </div>
                                <div class="monthly-summary-item">
                                    <div class="monthly-summary-label">ğŸª™ ê°€ìƒí™”íì¹´ë“œ ì§€ì¶œ</div>
                                    <div class="monthly-summary-value crypto" id="monthlyCryptoTotal">â‚¬0.00</div>
                                </div>
                                <div class="monthly-summary-item">
                                    <div class="monthly-summary-label">ğŸ’° ìˆ˜ì…</div>
                                    <div class="monthly-summary-value" style="color: #28a745;" id="monthlyIncome">â‚¬0.00</div>
                                </div>
                                <div class="monthly-summary-item">
                                    <div class="monthly-summary-label">ìˆœ ì§€ì¶œ</div>
                                    <div class="monthly-summary-value" id="monthlyNet">â‚¬0.00</div>
                                </div>
                            </div>
                        </div>

                        <div class="calendar">
                            <div class="calendar-weekdays">
                                <div class="calendar-weekday">ì¼</div>
                                <div class="calendar-weekday">ì›”</div>
                                <div class="calendar-weekday">í™”</div>
                                <div class="calendar-weekday">ìˆ˜</div>
                                <div class="calendar-weekday">ëª©</div>
                                <div class="calendar-weekday">ê¸ˆ</div>
                                <div class="calendar-weekday">í† </div>
                            </div>
                            <div class="calendar-days" id="calendarDays"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìì‚° íƒ­ -->
            <div id="assetsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">ğŸ’ ìì‚° ê´€ë¦¬</h2>
                
                <!-- ìì‚° ì¶”ê°€ í¼ -->
                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">ìì‚° ì¶”ê°€/ìˆ˜ì •</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>í”Œë«í¼ëª…</label>
                            <input type="text" id="assetPlatform" placeholder="ì˜ˆ: í•œêµ­ ì‹ í•œì€í–‰, ë…ì¼ Deutsche Bank">
                        </div>
                        <div class="input-group">
                            <label>í†µí™”</label>
                            <select id="assetCurrency">
                                <option value="EUR">EUR (â‚¬)</option>
                                <option value="KRW">KRW (â‚©)</option>
                                <option value="USD">USD ($)</option>
                                <option value="BTC">BTC (â‚¿)</option>
                                <option value="ETH">ETH (Î)</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>ì”ê³ </label>
                            <input type="number" id="assetAmount" placeholder="ê¸ˆì•¡ ì…ë ¥" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>ë©”ëª¨ (ì„ íƒ)</label>
                            <input type="text" id="assetMemo" placeholder="ì˜ˆ: ë¹„ìƒê¸ˆ, íˆ¬ììš©">
                        </div>
                    </div>
                    <button class="btn" onclick="addOrUpdateAsset()">ì¶”ê°€</button>
                </div>

                <!-- ì´ ìì‚° ìš”ì•½ -->
                <div class="monthly-summary" style="margin-bottom: 20px;">
                    <div class="monthly-summary-title">ğŸ’° ì´ ìì‚° (EUR í™˜ì‚°)</div>
                    <div style="font-size: 32px; font-weight: bold; color: #212529; margin-top: 10px;" id="totalAssetsEUR">
                        â‚¬0.00
                    </div>
                </div>

                <!-- ìì‚° ëª©ë¡ -->
                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
                    <h3 style="margin-bottom: 15px;">ìì‚° ëª©ë¡</h3>
                    <div id="assetsList"></div>
                </div>
            </div>

            <!-- í†µê³„ íƒ­ -->
            <div id="statsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ë¶„ì„</h2>
                
                <div class="monthly-summary" style="margin-bottom: 20px;">
                    <div class="monthly-summary-title">ì´ë²ˆ ë‹¬ ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</div>
                    <div id="categoryStats"></div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; color: #495057; border: 1px solid #e9ecef;">
                    <h4 style="margin-bottom: 10px; color: #212529;">ğŸ’¡ ì¹´í…Œê³ ë¦¬ ì•ˆë‚´</h4>
                    <p>AIê°€ ìë™ìœ¼ë¡œ ì§€ì¶œ í•­ëª©ì„ ë¶„ë¥˜í•©ë‹ˆë‹¤. ìˆ˜ì •ì´ í•„ìš”í•œ ê²½ìš° ì¼ë³„ì§€ì¶œ íƒ­ì—ì„œ ê° í•­ëª©ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ë‚ ì§œë³„ ìƒì„¸ ë‚´ì—­ ëª¨ë‹¬ -->
    <div class="modal" id="dateModal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalDate"></h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>

    <!-- ì§€ì¶œ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="editModal" onclick="closeEditModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ì§€ì¶œ/ìˆ˜ì… ìˆ˜ì •</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="edit-form">
                <div class="input-group">
                    <label>ìœ í˜•</label>
                    <select id="editTransactionType" onchange="updateEditPaymentMethodOptions()">
                        <option value="expense">ğŸ’¸ ì§€ì¶œ</option>
                        <option value="income">ğŸ’° ìˆ˜ì…</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>ë‚ ì§œ</label>
                    <input type="date" id="editDate">
                </div>
                <div class="input-group">
                    <label>í•­ëª©ëª…</label>
                    <input type="text" id="editName" placeholder="í•­ëª©ëª…">
                </div>
                <div class="input-group">
                    <label>ê¸ˆì•¡ (â‚¬)</label>
                    <input type="number" id="editAmount" placeholder="ê¸ˆì•¡">
                </div>
                <div class="input-group">
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="editCategory" style="flex: 1;">
                            <option value="ì‹ë¹„">ğŸ½ï¸ ì‹ë¹„</option>
                            <option value="êµí†µë¹„">ğŸš‡ êµí†µë¹„</option>
                            <option value="ì‡¼í•‘">ğŸ›ï¸ ì‡¼í•‘</option>
                            <option value="ë¬¸í™”ìƒí™œ">ğŸ¬ ë¬¸í™”ìƒí™œ</option>
                            <option value="êµ¬ë…ë£Œ">ğŸ“± êµ¬ë…ë£Œ</option>
                            <option value="ì˜ë£Œ">ğŸ¥ ì˜ë£Œ</option>
                            <option value="êµìœ¡">ğŸ“š êµìœ¡</option>
                            <option value="ìˆ˜ì…">ğŸ’° ìˆ˜ì…</option>
                            <option value="ê¸°íƒ€">ğŸ“¦ ê¸°íƒ€</option>
                        </select>
                        <button class="btn btn-secondary" onclick="aiClassifyInEdit(event)" style="white-space: nowrap;">ğŸ¤– AI</button>
                    </div>
                </div>
                <div class="input-group" id="editPaymentMethodGroup">
                    <label>ê²°ì œ ìˆ˜ë‹¨</label>
                    <select id="editPaymentMethod">
                        <option value="regular">ğŸ’³ ì¼ë°˜ì¹´ë“œ (í†µì¥)</option>
                        <option value="crypto">ğŸª™ ê°€ìƒí™”íì¹´ë“œ</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>ì¶œê¸ˆ ê³„ì¢Œ</label>
                    <select id="editFromAccount">
                        <option value="">ì„ íƒ ì•ˆí•¨</option>
                    </select>
                </div>
            </div>
            <div class="edit-actions">
                <button class="btn btn-cancel" onclick="closeEditModal()">ì·¨ì†Œ</button>
                <button class="btn" onclick="saveEdit()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script>
        // ë°ì´í„° ì €ì¥ì†Œ
        let salaries = []; // ì›”ë³„ ì›”ê¸‰ ë°°ì—´ë¡œ ë³€ê²½
        let fixedExpenses = [];
        let dailyExpenses = [];
        let currentCalendarDate = new Date(); // ë‹¬ë ¥ì— í‘œì‹œí•  í˜„ì¬ ë‚ ì§œ
        let currentView = 'list'; // 'list' ë˜ëŠ” 'calendar'
        let editingExpenseId = null; // í˜„ì¬ ìˆ˜ì • ì¤‘ì¸ ì§€ì¶œ ID
        let currentViewMonth = new Date(); // ë©”ì¸ í™”ë©´ì—ì„œ ë³´ê³  ìˆëŠ” ì›”
        let customCategories = []; // ì‚¬ìš©ì ì •ì˜ ì¹´í…Œê³ ë¦¬
        let assets = []; // ìì‚° ëª©ë¡

        // í™˜ìœ¨ (ê³ ì •ê°’ - ì‹¤ì œ ì‚¬ìš©ì‹œì—ëŠ” APIë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ)
        const exchangeRates = {
            'EUR': 1,
            'KRW': 0.00073, // 1 KRW = 0.00073 EUR
            'USD': 0.92, // 1 USD = 0.92 EUR
            'BTC': 85000, // 1 BTC = 85000 EUR (ì˜ˆì‹œ)
            'ETH': 2500 // 1 ETH = 2500 EUR (ì˜ˆì‹œ)
        };

        // í†µí™” ê¸°í˜¸ ë§¤í•‘
        const currencySymbols = {
            'EUR': 'â‚¬',
            'KRW': 'â‚©',
            'USD': '$',
            'BTC': 'â‚¿',
            'ETH': 'Î'
        };

        // ìì‚° ì¶”ê°€/ìˆ˜ì •
        function addOrUpdateAsset() {
            const platform = document.getElementById('assetPlatform').value.trim();
            const currency = document.getElementById('assetCurrency').value;
            const amount = parseFloat(document.getElementById('assetAmount').value);
            const memo = document.getElementById('assetMemo').value.trim();

            if (!platform || !amount) {
                alert('í”Œë«í¼ëª…ê³¼ ì”ê³ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ê°™ì€ í”Œë«í¼ì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
            const existingIndex = assets.findIndex(a => a.platform === platform && a.currency === currency);

            if (existingIndex !== -1) {
                // ì—…ë°ì´íŠ¸
                assets[existingIndex].amount = amount;
                assets[existingIndex].memo = memo;
                assets[existingIndex].updatedAt = new Date().toISOString();
            } else {
                // ìƒˆë¡œ ì¶”ê°€
                assets.push({
                    id: Date.now(),
                    platform: platform,
                    currency: currency,
                    amount: amount,
                    memo: memo,
                    createdAt: new Date().toISOString()
                });
            }

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('assetPlatform').value = '';
            document.getElementById('assetAmount').value = '';
            document.getElementById('assetMemo').value = '';
            document.getElementById('assetCurrency').value = 'EUR';

            saveData();
            renderAssetsList();
        }

        // ìì‚° ì‚­ì œ
        function deleteAsset(id) {
            if (confirm('ì´ ìì‚°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                assets = assets.filter(a => a.id !== id);
                saveData();
                renderAssetsList();
            }
        }

        // ìì‚° ëª©ë¡ ë Œë”ë§
        function renderAssetsList() {
            const list = document.getElementById('assetsList');
            
            if (assets.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’</div>
                        <p>ë“±ë¡ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                document.getElementById('totalAssetsEUR').textContent = 'â‚¬0.00';
                updateAccountDropdowns();
                return;
            }

            // ì´ ìì‚° ê³„ì‚° (EUR ê¸°ì¤€)
            let totalEUR = 0;
            
            let html = '';
            assets.forEach(asset => {
                const symbol = currencySymbols[asset.currency];
                const valueInEUR = asset.amount * exchangeRates[asset.currency];
                totalEUR += valueInEUR;

                html += `
                    <div class="list-item">
                        <div class="list-item-info">
                            <div class="list-item-name">
                                ${asset.platform}
                                ${asset.memo ? `<span style="color: #6c757d; font-size: 13px; margin-left: 8px;">(${asset.memo})</span>` : ''}
                            </div>
                            <div class="list-item-detail">
                                ${symbol}${asset.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}
                                ${asset.currency}
                                ${asset.currency !== 'EUR' ? `<span style="color: #6c757d; margin-left: 8px;">â‰ˆ â‚¬${valueInEUR.toFixed(2)}</span>` : ''}
                            </div>
                        </div>
                        <button class="btn btn-delete" onclick="deleteAsset(${asset.id})">ì‚­ì œ</button>
                    </div>
                `;
            });

            list.innerHTML = html;
            document.getElementById('totalAssetsEUR').textContent = `â‚¬${totalEUR.toFixed(2)}`;
            
            // ê³„ì¢Œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
            updateAccountDropdowns();
        }

        // ê³„ì¢Œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        function updateAccountDropdowns() {
            const fromAccountSelect = document.getElementById('fromAccount');
            const editFromAccountSelect = document.getElementById('editFromAccount');
            
            if (!fromAccountSelect) return;
            
            let html = '<option value="">ì„ íƒ ì•ˆí•¨ (ìì‚° ë³€ë™ ì—†ìŒ)</option>';
            
            assets.forEach(asset => {
                const symbol = currencySymbols[asset.currency];
                const displayText = `${asset.platform} (${symbol}${asset.amount.toFixed(2)} ${asset.currency})`;
                html += `<option value="${asset.id}">${displayText}</option>`;
            });
            
            fromAccountSelect.innerHTML = html;
            
            if (editFromAccountSelect) {
                editFromAccountSelect.innerHTML = html;
            }
        }

        // ê¸°ë³¸ ì¹´í…Œê³ ë¦¬
        const defaultCategories = [
            { name: 'ì‹ë¹„', emoji: 'ğŸ½ï¸' },
            { name: 'êµí†µë¹„', emoji: 'ğŸš‡' },
            { name: 'ì‡¼í•‘', emoji: 'ğŸ›ï¸' },
            { name: 'ë¬¸í™”ìƒí™œ', emoji: 'ğŸ¬' },
            { name: 'êµ¬ë…ë£Œ', emoji: 'ğŸ“±' },
            { name: 'ì˜ë£Œ', emoji: 'ğŸ¥' },
            { name: 'êµìœ¡', emoji: 'ğŸ“š' },
            { name: 'ê¸°íƒ€', emoji: 'ğŸ“¦' }
        ];

        // ëª¨ë“  ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ + ì‚¬ìš©ì ì •ì˜)
        function getAllCategories() {
            return [...defaultCategories, ...customCategories];
        }

        // ì¹´í…Œê³ ë¦¬ ì´ëª¨ì§€ ê°€ì ¸ì˜¤ê¸°
        function getCategoryEmoji(categoryName) {
            const allCategories = getAllCategories();
            const category = allCategories.find(c => c.name === categoryName);
            return category ? category.emoji : 'ğŸ“¦';
        }

        // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì˜µì…˜ ë Œë”ë§
        function renderCategoryOptions(selectElementId, includeAI = false) {
            const select = document.getElementById(selectElementId);
            if (!select) return;
            
            const allCategories = getAllCategories();
            let html = '';
            
            if (includeAI) {
                html += '<option value="">ğŸ¤– AI ìë™ ë¶„ë¥˜</option>';
            }
            
            allCategories.forEach(cat => {
                html += `<option value="${cat.name}">${cat.emoji} ${cat.name}</option>`;
            });
            
            html += '<option value="ìˆ˜ì…">ğŸ’° ìˆ˜ì…</option>';
            
            const currentValue = select.value;
            select.innerHTML = html;
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // ì‚¬ìš©ì ì •ì˜ ì¹´í…Œê³ ë¦¬ ì¶”ê°€
        function addCustomCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const emoji = document.getElementById('newCategoryEmoji').value.trim();
            
            if (!name) {
                alert('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì¤‘ë³µ ì²´í¬
            const allCategories = getAllCategories();
            if (allCategories.some(c => c.name === name)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤.');
                return;
            }
            
            customCategories.push({
                name: name,
                emoji: emoji || 'ğŸ“Œ'
            });
            
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryEmoji').value = '';
            
            saveData();
            renderCustomCategoryList();
            updateAllCategorySelects();
            
            alert(`"${emoji || 'ğŸ“Œ'} ${name}" ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }

        // ì‚¬ìš©ì ì •ì˜ ì¹´í…Œê³ ë¦¬ ì‚­ì œ
        function deleteCustomCategory(index) {
            const category = customCategories[index];
            const confirmed = confirm(`"${category.emoji} ${category.name}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            
            if (confirmed) {
                customCategories.splice(index, 1);
                saveData();
                renderCustomCategoryList();
                updateAllCategorySelects();
            }
        }

        // ì‚¬ìš©ì ì •ì˜ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë Œë”ë§
        function renderCustomCategoryList() {
            const list = document.getElementById('customCategoryList');
            if (!list) return;
            
            if (customCategories.length === 0) {
                list.innerHTML = '<span style="color: #6c757d; font-size: 14px;">ì¶”ê°€í•œ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
                return;
            }
            
            list.innerHTML = customCategories.map((cat, index) => `
                <span style="display: inline-flex; align-items: center; gap: 5px; padding: 5px 10px; background: white; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                    ${cat.emoji} ${cat.name}
                    <button onclick="deleteCustomCategory(${index})" style="background: none; border: none; color: #dc3545; cursor: pointer; padding: 0; margin-left: 5px; font-size: 16px;">Ã—</button>
                </span>
            `).join('');
        }

        // ëª¨ë“  ì¹´í…Œê³ ë¦¬ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        function updateAllCategorySelects() {
            renderCategoryOptions('categorySelect', true);
            renderCategoryOptions('editCategory', false);
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        function loadData() {
            const savedData = localStorage.getItem('budgetAppEuro_v2');
            if (savedData) {
                const data = JSON.parse(savedData);
                salaries = data.salaries || [];
                fixedExpenses = data.fixedExpenses || [];
                dailyExpenses = data.dailyExpenses || [];
                customCategories = data.customCategories || [];
                assets = data.assets || [];
                
                console.log('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ:', {
                    salaries: salaries.length,
                    fixedExpenses: fixedExpenses.length,
                    dailyExpenses: dailyExpenses.length,
                    customCategories: customCategories.length,
                    assets: assets.length
                });
                
                // ê¸°ì¡´ ë°ì´í„°ì— ì¹´í…Œê³ ë¦¬ í•„ë“œê°€ ì—†ìœ¼ë©´ ì¶”ê°€ (ë§ˆì´ê·¸ë ˆì´ì…˜)
                dailyExpenses = dailyExpenses.map(expense => {
                    if (!expense.category) {
                        // ìˆ˜ì…ì¸ ê²½ìš°
                        if (expense.type === 'income') {
                            expense.category = 'ìˆ˜ì…';
                        } else {
                            // ì§€ì¶œì¸ ê²½ìš° ê¸°ë³¸ê°’
                            expense.category = 'ê¸°íƒ€';
                        }
                    }
                    return expense;
                });
                
                console.log('ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ, ìƒ˜í”Œ ë°ì´í„°:', dailyExpenses[0]);
                
                // ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ì €ì¥
                saveData();
                
                updateDisplay();
                renderFixedList();
                renderDailyList();
                renderSalaryList();
                renderAssetsList();
            }
            // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì •
            document.getElementById('dailyDate').valueAsDate = new Date();
            // í˜„ì¬ ì›” ê¸°ë³¸ê°’ ì„¤ì •
            const now = new Date();
            const currentMonth = now.toISOString().slice(0, 7);
            document.getElementById('salaryMonth').value = currentMonth;
            
            // ë©”ì¸ í™”ë©´ ì›” í‘œì‹œ ì—…ë°ì´íŠ¸
            updateViewMonthDisplay();
            
            // ì¹´í…Œê³ ë¦¬ UI ì—…ë°ì´íŠ¸
            updateAllCategorySelects();
            renderCustomCategoryList();
            
            // ê³„ì¢Œ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
            updateAccountDropdowns();
        }

        // ë°ì´í„° ì €ì¥
        function saveData() {
            const data = {
                salaries: salaries,
                fixedExpenses: fixedExpenses,
                dailyExpenses: dailyExpenses,
                customCategories: customCategories,
                assets: assets
            };
            localStorage.setItem('budgetAppEuro_v2', JSON.stringify(data));
        }

        // ë©”ì¸ í™”ë©´ ì›” ë³€ê²½
        function changeViewMonth(delta) {
            currentViewMonth.setMonth(currentViewMonth.getMonth() + delta);
            updateViewMonthDisplay();
            updateDisplay();
            renderDailyList();
        }

        // ë©”ì¸ í™”ë©´ ì›” í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateViewMonthDisplay() {
            const year = currentViewMonth.getFullYear();
            const month = currentViewMonth.getMonth() + 1;
            document.getElementById('viewMonth').textContent = `${year}ë…„ ${month}ì›”`;
        }

        // í•´ë‹¹ ì›”ì˜ ì¼ë³„ì§€ì¶œ í•„í„°ë§
        // í•´ë‹¹ ì›”ì˜ ì¼ë³„ì§€ì¶œ í•„í„°ë§
        function getMonthlyExpenses(year, month) {
            return dailyExpenses.filter(expense => {
                if (!expense.date) return false;
                
                // YYYY-MM-DD í˜•ì‹ì˜ ë‚ ì§œë¥¼ ì•ˆì „í•˜ê²Œ íŒŒì‹±
                const [expenseYear, expenseMonth, expenseDay] = expense.date.split('-').map(Number);
                return expenseYear === year && (expenseMonth - 1) === month;
            });
        }

        // í•´ë‹¹ ì›”ì˜ ì›”ê¸‰ ê°€ì ¸ì˜¤ê¸°
        function getMonthlySalary(year, month) {
            const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            const salary = salaries.find(s => s.month === monthStr);
            return salary ? salary.amount : 0;
        }

        // íƒ­ ì „í™˜
        function switchTab(evt, tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            evt.currentTarget.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // í†µê³„ íƒ­ìœ¼ë¡œ ì „í™˜ ì‹œ í†µê³„ ë Œë”ë§
            if (tab === 'stats') {
                renderCategoryStats();
            }
        }

        // ê±°ë˜ ìœ í˜•ì— ë”°ë¼ ê²°ì œ ìˆ˜ë‹¨ í‘œì‹œ/ìˆ¨ê¹€
        function updatePaymentMethodOptions() {
            const transactionType = document.getElementById('transactionType').value;
            const paymentMethodGroup = document.getElementById('paymentMethodGroup');
            
            if (transactionType === 'income') {
                paymentMethodGroup.style.display = 'none';
            } else {
                paymentMethodGroup.style.display = 'block';
            }
        }

        // ì›”ê¸‰ ì„¤ì •
        function setSalary() {
            const monthInput = document.getElementById('salaryMonth');
            const amountInput = document.getElementById('salaryInput');
            const month = monthInput.value;
            const amount = parseFloat(amountInput.value);

            if (!month || !amount) {
                alert('ì›”ê³¼ ê¸ˆì•¡ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ê°™ì€ ì›”ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ì¶”ê°€
            const existingIndex = salaries.findIndex(s => s.month === month);
            if (existingIndex >= 0) {
                salaries[existingIndex].amount = amount;
            } else {
                salaries.push({
                    id: Date.now(),
                    month: month,
                    amount: amount
                });
            }

            // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
            salaries.sort((a, b) => b.month.localeCompare(a.month));

            amountInput.value = '';

            saveData();
            updateDisplay();
            renderSalaryList();
            alert('ì›”ê¸‰ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ì›”ê¸‰ ì‚­ì œ
        function deleteSalary(id) {
            salaries = salaries.filter(s => s.id !== id);
            saveData();
            updateDisplay();
            renderSalaryList();
        }

        // ì›”ê¸‰ ëª©ë¡ ë Œë”ë§
        function renderSalaryList() {
            const list = document.getElementById('salaryList');
            
            if (salaries.length === 0) {
                list.innerHTML = `
                    <h3 style="margin: 20px 0 15px 0; color: #333;">ì›”ë³„ ì›”ê¸‰ ë‚´ì—­</h3>
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’¶</div>
                        <p>ì•„ì§ ì›”ê¸‰ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            let html = '<h3 style="margin: 20px 0 15px 0; color: #333;">ì›”ë³„ ì›”ê¸‰ ë‚´ì—­</h3>';
            html += salaries.map(salary => {
                const [year, month] = salary.month.split('-');
                const displayMonth = `${year}ë…„ ${month}ì›”`;
                return `
                    <div class="list-item">
                        <div class="list-item-info">
                            <div class="list-item-name">${displayMonth}</div>
                        </div>
                        <div class="list-item-amount">${formatCurrency(salary.amount)}</div>
                        <button class="btn btn-delete" onclick="deleteSalary(${salary.id})">ì‚­ì œ</button>
                    </div>
                `;
            }).join('');

            list.innerHTML = html;
        }

        // ê³ ì •ì§€ì¶œ ì¶”ê°€
        function addFixedExpense() {
            const name = document.getElementById('fixedName').value;
            const amount = parseFloat(document.getElementById('fixedAmount').value);

            if (!name || !amount) {
                alert('í•­ëª©ëª…ê³¼ ê¸ˆì•¡ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            fixedExpenses.push({
                id: Date.now(),
                name: name,
                amount: amount
            });

            document.getElementById('fixedName').value = '';
            document.getElementById('fixedAmount').value = '';

            saveData();
            updateDisplay();
            renderFixedList();
        }

        // ì¼ë³„ì§€ì¶œ ì¶”ê°€
        async function addDailyExpense() {
            const date = document.getElementById('dailyDate').value;
            const name = document.getElementById('dailyName').value;
            const amount = parseFloat(document.getElementById('dailyAmount').value);
            const transactionType = document.getElementById('transactionType').value;
            const paymentMethod = transactionType === 'income' ? 'income' : document.getElementById('paymentMethod').value;
            const fromAccountId = document.getElementById('fromAccount').value;
            let category = document.getElementById('categorySelect').value;

            if (!date || !name || !amount) {
                alert('ë‚ ì§œ, í•­ëª©ëª…, ê¸ˆì•¡ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // AI ìë™ ë¶„ë¥˜ê°€ ì„ íƒëœ ê²½ìš°
            if (!category && transactionType === 'expense') {
                // ë¡œë”© í‘œì‹œ
                const addButton = event.target;
                const originalText = addButton.textContent;
                addButton.textContent = 'AI ë¶„ë¥˜ ì¤‘...';
                addButton.disabled = true;
                
                try {
                    category = await classifyExpenseWithAI(name);
                    console.log(`"${name}" â†’ "${category}"ë¡œ ë¶„ë¥˜ë¨`);
                } catch (error) {
                    console.error('AI ë¶„ë¥˜ ì‹¤íŒ¨:', error);
                    category = 'ê¸°íƒ€';
                } finally {
                    addButton.textContent = originalText;
                    addButton.disabled = false;
                }
            } else if (transactionType === 'income') {
                category = 'ìˆ˜ì…';
            }

            // ê³„ì¢Œì—ì„œ ì°¨ê°/ì…ê¸ˆ
            if (fromAccountId) {
                const account = assets.find(a => a.id === parseInt(fromAccountId));
                if (account) {
                    if (transactionType === 'expense') {
                        account.amount -= amount;
                        if (account.amount < 0) {
                            const confirmed = confirm(`${account.platform} ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ê·¸ë˜ë„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ì”ì•¡: ${currencySymbols[account.currency]}${(account.amount + amount).toFixed(2)}\nì§€ì¶œ í›„: ${currencySymbols[account.currency]}${account.amount.toFixed(2)}`);
                            if (!confirmed) {
                                account.amount += amount; // ì›ë³µ
                                return;
                            }
                        }
                    } else {
                        // ìˆ˜ì…ì¸ ê²½ìš° ì…ê¸ˆ
                        account.amount += amount;
                    }
                    account.updatedAt = new Date().toISOString();
                }
            }

            dailyExpenses.push({
                id: Date.now(),
                date: date,
                name: name,
                amount: amount,
                paymentMethod: paymentMethod,
                type: transactionType,
                category: category || 'ê¸°íƒ€',
                fromAccountId: fromAccountId ? parseInt(fromAccountId) : null
            });

            document.getElementById('dailyName').value = '';
            document.getElementById('dailyAmount').value = '';
            document.getElementById('transactionType').value = 'expense';
            document.getElementById('paymentMethod').value = 'regular';
            document.getElementById('categorySelect').value = '';
            document.getElementById('fromAccount').value = '';
            updatePaymentMethodOptions();

            saveData();
            updateDisplay();
            renderDailyList();
            renderAssetsList(); // ìì‚° ëª©ë¡ë„ ì—…ë°ì´íŠ¸
            
            // ë‹¬ë ¥ ë³´ê¸°ê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë‹¬ë ¥ë„ ì—…ë°ì´íŠ¸
            if (currentView === 'calendar') {
                renderCalendar();
            }
        }

        // AIë¡œ ì§€ì¶œ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
        async function classifyExpenseWithAI(itemName) {
            try {
                const allCategories = getAllCategories();
                const categoryNames = allCategories.map(c => c.name).join(', ');
                
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 50,
                        messages: [
                            {
                                role: 'user',
                                content: `ë‹¤ìŒ ì§€ì¶œ í•­ëª©ì„ ê°€ì¥ ì í•©í•œ ì¹´í…Œê³ ë¦¬ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”: "${itemName}"

ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´í…Œê³ ë¦¬: ${categoryNames}

ì˜ˆì‹œ:
- "ë²„ê±°í‚¹", "ë§¥ë„ë‚ ë“œ", "ë°¥", "ì»¤í”¼", "ì‹ë‹¹" â†’ ì‹ë¹„
- "ë²„ìŠ¤", "ì§€í•˜ì² ", "íƒì‹œ", "ê¸°ì°¨í‘œ" â†’ êµí†µë¹„
- "ì˜·", "ì‹ ë°œ", "ê°€ë°©", "í™”ì¥í’ˆ" â†’ ì‡¼í•‘
- "ì˜í™”", "ê³µì—°", "ê²Œì„", "ë„·í”Œë¦­ìŠ¤" â†’ ë¬¸í™”ìƒí™œ
- "ìœ íŠœë¸Œ í”„ë¦¬ë¯¸ì—„", "ìŠ¤í¬í‹°íŒŒì´", "êµ¬ë…" â†’ êµ¬ë…ë£Œ
- "ë³‘ì›", "ì•½", "ê±´ê°•ê²€ì§„" â†’ ì˜ë£Œ
- "ì±…", "ê°•ì˜", "í•™ì›" â†’ êµìœ¡

ë°˜ë“œì‹œ ìœ„ ì¹´í…Œê³ ë¦¬ ì¤‘ í•˜ë‚˜ë§Œ ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ ë§ì€ í•˜ì§€ ë§ˆì„¸ìš”.`
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API ì˜¤ë¥˜:', response.status, errorText);
                    throw new Error('AI ë¶„ë¥˜ ì‹¤íŒ¨');
                }

                const data = await response.json();
                const category = data.content[0].text.trim();
                
                console.log('AI ì‘ë‹µ:', category);
                
                // ìœ íš¨í•œ ì¹´í…Œê³ ë¦¬ì¸ì§€ í™•ì¸
                const validCategories = allCategories.map(c => c.name);
                return validCategories.includes(category) ? category : 'ê¸°íƒ€';
            } catch (error) {
                console.error('AI ë¶„ë¥˜ ì˜¤ë¥˜:', error);
                return 'ê¸°íƒ€';
            }
        }

        // ê¸°ì¡´ ë‚´ì—­ ì¼ê´„ AI ë¶„ë¥˜
        // ê¸°ì¡´ ë‚´ì—­ ì¼ê´„ AI ë¶„ë¥˜
        async function bulkClassifyExpenses(evt) {
            console.log('=== ì¼ê´„ ë¶„ë¥˜ ì‹œì‘ ===');
            console.log('ì „ì²´ dailyExpenses ê°œìˆ˜:', dailyExpenses.length);
            
            // ì¹´í…Œê³ ë¦¬ê°€ "ê¸°íƒ€"ì¸ ì§€ì¶œë§Œ í•„í„°ë§
            const unclassifiedExpenses = dailyExpenses.filter(e => 
                e.type !== 'income' && (e.category === 'ê¸°íƒ€' || !e.category)
            );

            console.log('ë¶„ë¥˜ ëŒ€ìƒ ê°œìˆ˜:', unclassifiedExpenses.length);

            if (unclassifiedExpenses.length === 0) {
                alert('ë¶„ë¥˜í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  í•­ëª©ì´ ì´ë¯¸ ë¶„ë¥˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            alert(`${unclassifiedExpenses.length}ê°œì˜ í•­ëª©ì„ AIë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`);
            
            console.log('ë¶„ë¥˜ ì‹œì‘!');

            // ë²„íŠ¼ ì°¾ê¸°
            const button = evt.target;
            const originalText = button.textContent;
            button.textContent = 'ë¶„ë¥˜ ì¤‘...';
            button.disabled = true;

            try {
                let classified = 0;
                let failed = 0;
                
                console.log('for ë£¨í”„ ì‹œì‘');
                
                for (let i = 0; i < unclassifiedExpenses.length; i++) {
                    const expense = unclassifiedExpenses[i];
                    console.log(`\n=== [${i+1}/${unclassifiedExpenses.length}] ì²˜ë¦¬ ì‹œì‘ ===`);
                    console.log('í•­ëª©:', expense.name, 'ID:', expense.id);
                    
                    try {
                        console.log('AI ë¶„ë¥˜ í˜¸ì¶œ ì „...');
                        const category = await classifyExpenseWithAI(expense.name);
                        console.log('AI ë¶„ë¥˜ ê²°ê³¼:', category);
                        
                        // ì›ë³¸ ë°°ì—´ì—ì„œ í•´ë‹¹ í•­ëª© ì°¾ì•„ì„œ ì§ì ‘ ìˆ˜ì •
                        const index = dailyExpenses.findIndex(e => e.id === expense.id);
                        console.log('ë°°ì—´ ì¸ë±ìŠ¤:', index);
                        
                        if (index !== -1) {
                            console.log('ìˆ˜ì • ì „ ì¹´í…Œê³ ë¦¬:', dailyExpenses[index].category);
                            dailyExpenses[index].category = category;
                            console.log('ìˆ˜ì • í›„ ì¹´í…Œê³ ë¦¬:', dailyExpenses[index].category);
                        } else {
                            console.error('âŒ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ!');
                        }
                        
                        classified++;
                        button.textContent = `${classified}/${unclassifiedExpenses.length} ì²˜ë¦¬ ì¤‘...`;
                        
                        // API í˜¸ì¶œ ê°„ ì§§ì€ ì§€ì—°
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        console.error(`âŒ ë¶„ë¥˜ ì‹¤íŒ¨ (${expense.name}):`, error);
                        failed++;
                    }
                }

                console.log('\n=== ë¶„ë¥˜ ì™„ë£Œ ===');
                console.log('ì„±ê³µ:', classified, 'ì‹¤íŒ¨:', failed);
                
                saveData();
                console.log('ë°ì´í„° ì €ì¥ ì™„ë£Œ');
                
                renderDailyList();
                console.log('ëª©ë¡ ë Œë”ë§ ì™„ë£Œ');
                
                if (failed > 0) {
                    alert(`âœ… ${classified}ê°œ í•­ëª© ë¶„ë¥˜ ì™„ë£Œ\nâš ï¸ ${failed}ê°œ í•­ëª© ë¶„ë¥˜ ì‹¤íŒ¨`);
                } else {
                    alert(`âœ… ${classified}ê°œ í•­ëª©ì˜ ë¶„ë¥˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                }
            } catch (error) {
                console.error('âŒ ì¼ê´„ ë¶„ë¥˜ ì˜¤ë¥˜:', error);
                alert('ë¶„ë¥˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // ìˆ˜ì • ëª¨ë‹¬ì—ì„œ AI ë¶„ë¥˜
        async function aiClassifyInEdit(evt) {
            const itemName = document.getElementById('editName').value;
            
            if (!itemName) {
                alert('í•­ëª©ëª…ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const button = evt.target;
            const originalText = button.textContent;
            button.textContent = 'ë¶„ë¥˜ ì¤‘...';
            button.disabled = true;

            try {
                const category = await classifyExpenseWithAI(itemName);
                document.getElementById('editCategory').value = category;
                alert(`"${category}" ì¹´í…Œê³ ë¦¬ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error('AI ë¶„ë¥˜ ì˜¤ë¥˜:', error);
                alert('ë¶„ë¥˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // ê³ ì •ì§€ì¶œ ì‚­ì œ
        function deleteFixedExpense(id) {
            fixedExpenses = fixedExpenses.filter(e => e.id !== id);
            saveData();
            updateDisplay();
            renderFixedList();
        }

        // ì¼ë³„ì§€ì¶œ ì‚­ì œ
        function deleteDailyExpense(id) {
            const expense = dailyExpenses.find(e => e.id === id);
            
            // ê³„ì¢Œë¡œ ë³µì›
            if (expense && expense.fromAccountId) {
                const account = assets.find(a => a.id === expense.fromAccountId);
                if (account) {
                    if (expense.type === 'expense') {
                        // ì§€ì¶œì„ ì‚­ì œí•˜ë©´ ê³„ì¢Œì— ë‹¤ì‹œ ì¶”ê°€
                        account.amount += expense.amount;
                    } else {
                        // ìˆ˜ì…ì„ ì‚­ì œí•˜ë©´ ê³„ì¢Œì—ì„œ ì°¨ê°
                        account.amount -= expense.amount;
                    }
                    account.updatedAt = new Date().toISOString();
                }
            }
            
            dailyExpenses = dailyExpenses.filter(e => e.id !== id);
            saveData();
            updateDisplay();
            renderDailyList();
            renderAssetsList(); // ìì‚° ëª©ë¡ë„ ì—…ë°ì´íŠ¸
            
            // ë‹¬ë ¥ ë³´ê¸°ê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë‹¬ë ¥ë„ ì—…ë°ì´íŠ¸
            if (currentView === 'calendar') {
                renderCalendar();
            }
        }

        // ê¸ˆì•¡ í¬ë§·íŒ… (ìœ ë¡œ)
        function formatCurrency(amount) {
            return 'â‚¬' + amount.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // ìƒë‹¨ ìš”ì•½ ì—…ë°ì´íŠ¸
        function updateDisplay() {
            const year = currentViewMonth.getFullYear();
            const month = currentViewMonth.getMonth();
            
            // í•´ë‹¹ ì›”ì˜ ì›”ê¸‰ ê°€ì ¸ì˜¤ê¸°
            const currentSalary = getMonthlySalary(year, month);
            
            const totalFixed = fixedExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            // í•´ë‹¹ ì›”ì˜ ì¼ë³„ì§€ì¶œë§Œ ê°€ì ¸ì˜¤ê¸°
            const monthlyExpenses = getMonthlyExpenses(year, month);
            
            // ì§€ì¶œê³¼ ìˆ˜ì… ë¶„ë¦¬
            const expenses = monthlyExpenses.filter(e => e.type !== 'income');
            const incomes = monthlyExpenses.filter(e => e.type === 'income');
            
            // ì¼ë°˜ì¹´ë“œì™€ ê°€ìƒí™”íì¹´ë“œ ì§€ì¶œ ë¶„ë¦¬
            const regularExpenses = expenses.filter(e => (e.paymentMethod || 'regular') === 'regular');
            const cryptoExpenses = expenses.filter(e => e.paymentMethod === 'crypto');
            
            const totalRegular = regularExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalCrypto = cryptoExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalIncome = incomes.reduce((sum, e) => sum + e.amount, 0);
            
            // í†µì¥ì—ì„œ ë‚˜ê°€ëŠ” ê¸ˆì•¡ ê³„ì‚° (ì›”ê¸‰ + ìˆ˜ì… - ê³ ì •ì§€ì¶œ - ì¼ë°˜ì¹´ë“œì§€ì¶œ)
            const remaining = currentSalary + totalIncome - totalFixed - totalRegular;

            document.getElementById('salaryDisplay').textContent = formatCurrency(currentSalary);
            document.getElementById('incomeDisplay').textContent = formatCurrency(totalIncome);
            document.getElementById('fixedExpenseDisplay').textContent = formatCurrency(totalFixed);
            document.getElementById('dailyExpenseDisplay').textContent = formatCurrency(totalRegular);
            document.getElementById('cryptoExpenseDisplay').textContent = formatCurrency(totalCrypto);
            document.getElementById('remainingDisplay').textContent = formatCurrency(remaining);

            // ë‚¨ì€ ê¸ˆì•¡ ìƒ‰ìƒ ë³€ê²½
            const remainingEl = document.getElementById('remainingDisplay');
            if (remaining < 0) {
                remainingEl.style.color = '#212529';
                remainingEl.style.fontWeight = 'bold';
            } else if (remaining < currentSalary * 0.2) {
                remainingEl.style.color = '#495057';
            } else {
                remainingEl.style.color = '#212529';
            }
        }

        // ê³ ì •ì§€ì¶œ ëª©ë¡ ë Œë”ë§
        function renderFixedList() {
            const list = document.getElementById('fixedList');
            
            if (fixedExpenses.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <p>ì•„ì§ ê³ ì •ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = fixedExpenses.map((expense, index) => `
                <div class="list-item" draggable="true" data-id="${expense.id}" data-index="${index}">
                    <div class="drag-handle">â‹®â‹®</div>
                    <div class="list-item-info">
                        <div class="list-item-name">${expense.name}</div>
                    </div>
                    <div class="list-item-amount">${formatCurrency(expense.amount)}</div>
                    <button class="btn btn-delete" onclick="deleteFixedExpense(${expense.id})">ì‚­ì œ</button>
                </div>
            `).join('');

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            setupDragAndDrop();
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
        function setupDragAndDrop() {
            const items = document.querySelectorAll('#fixedList .list-item');
            let draggedItem = null;
            let draggedIndex = null;

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    draggedIndex = parseInt(item.dataset.index);
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', (e) => {
                    item.classList.remove('dragging');
                    // ëª¨ë“  drag-over í´ë˜ìŠ¤ ì œê±°
                    items.forEach(i => i.classList.remove('drag-over'));
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    if (item !== draggedItem) {
                        item.classList.add('drag-over');
                    }
                });

                item.addEventListener('dragleave', (e) => {
                    item.classList.remove('drag-over');
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    
                    if (item !== draggedItem) {
                        const dropIndex = parseInt(item.dataset.index);
                        
                        // ë°°ì—´ì—ì„œ í•­ëª© ìˆœì„œ ë³€ê²½
                        const movedItem = fixedExpenses.splice(draggedIndex, 1)[0];
                        fixedExpenses.splice(dropIndex, 0, movedItem);
                        
                        // ì €ì¥ ë° ë‹¤ì‹œ ë Œë”ë§
                        saveData();
                        renderFixedList();
                    }
                });
            });
        }

        // ì¼ë³„ì§€ì¶œ ëª©ë¡ ë Œë”ë§
        function renderDailyList() {
            const year = currentViewMonth.getFullYear();
            const month = currentViewMonth.getMonth();
            
            // í•´ë‹¹ ì›”ì˜ ì§€ì¶œë§Œ í•„í„°ë§
            const monthlyExpenses = getMonthlyExpenses(year, month);
            
            // ì§€ì¶œê³¼ ìˆ˜ì… ë¶„ë¦¬
            const expenses = monthlyExpenses.filter(e => e.type !== 'income');
            const incomes = monthlyExpenses.filter(e => e.type === 'income');
            
            // ì›”ë³„ ì´ ì§€ì¶œ ê³„ì‚° ë° í‘œì‹œ
            const monthlyRegular = expenses
                .filter(e => (e.paymentMethod || 'regular') === 'regular')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const monthlyCrypto = expenses
                .filter(e => e.paymentMethod === 'crypto')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const monthlyIncome = incomes.reduce((sum, e) => sum + e.amount, 0);
            const monthlyNet = monthlyRegular + monthlyCrypto - monthlyIncome;

            document.getElementById('listMonthlyRegularTotal').textContent = formatCurrency(monthlyRegular);
            document.getElementById('listMonthlyCryptoTotal').textContent = formatCurrency(monthlyCrypto);
            document.getElementById('listMonthlyIncome').textContent = formatCurrency(monthlyIncome);
            document.getElementById('listMonthlyNet').textContent = formatCurrency(monthlyNet);
            
            const list = document.getElementById('dailyList');
            
            if (monthlyExpenses.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“…</div>
                        <p>ì´ë²ˆ ë‹¬ ì¼ë³„ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
            const sorted = [...monthlyExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));

            list.innerHTML = sorted.map(expense => {
                const isIncome = expense.type === 'income';
                const paymentMethod = expense.paymentMethod || 'regular';
                const category = expense.category || 'ê¸°íƒ€';
                
                let badge = '';
                let amountClass = '';
                
                if (isIncome) {
                    badge = '<span class="payment-badge income">ğŸ’° ìˆ˜ì…</span>';
                    amountClass = ' income';
                } else if (paymentMethod === 'crypto') {
                    badge = '<span class="payment-badge crypto">ğŸª™ ê°€ìƒí™”í</span>';
                } else {
                    badge = '<span class="payment-badge regular">ğŸ’³ ì¼ë°˜</span>';
                }
                
                // ì¹´í…Œê³ ë¦¬ ì´ëª¨ì§€ ë§¤í•‘
                const categoryEmoji = getCategoryEmoji(category);
                const categoryBadge = `<span class="category-badge">${categoryEmoji} ${category}</span>`;
                
                return `
                    <div class="list-item${isIncome ? ' income' : ''}">
                        <div class="list-item-info">
                            <div class="list-item-name">${expense.name} ${badge} ${categoryBadge}</div>
                            <div class="list-item-detail">${expense.date}</div>
                        </div>
                        <div class="list-item-amount${amountClass}">${isIncome ? '+' : ''}${formatCurrency(expense.amount)}</div>
                        <button class="btn btn-edit" onclick="editDailyExpense(${expense.id})">ìˆ˜ì •</button>
                        <button class="btn btn-delete" onclick="deleteDailyExpense(${expense.id})">ì‚­ì œ</button>
                    </div>
                `;
            }).join('');
        }

        // ë³´ê¸° ì „í™˜ (ëª©ë¡/ë‹¬ë ¥)
        function switchDailyView(view) {
            currentView = view;
            const listView = document.getElementById('dailyListView');
            const calendarView = document.getElementById('dailyCalendarView');
            const buttons = document.querySelectorAll('.view-toggle button');

            buttons.forEach(btn => btn.classList.remove('active'));

            if (view === 'list') {
                listView.style.display = 'block';
                calendarView.style.display = 'none';
                buttons[0].classList.add('active');
            } else {
                listView.style.display = 'none';
                calendarView.style.display = 'block';
                buttons[1].classList.add('active');
                renderCalendar();
            }
        }

        // ë‹¬ë ¥ ì›” ë³€ê²½
        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        // ë‹¬ë ¥ ë Œë”ë§
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // ì›” í‘œì‹œ ì—…ë°ì´íŠ¸
            const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
            document.getElementById('calendarMonth').textContent = `${year}ë…„ ${monthNames[month]}`;

            // ì´ë²ˆ ë‹¬ì˜ ì²«ë‚ ê³¼ ë§ˆì§€ë§‰ ë‚ 
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // ë‹¬ë ¥ ì‹œì‘ì¼ (ì´ì „ ë‹¬ í¬í•¨)
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // ë‹¬ë ¥ ì¢…ë£Œì¼ (ë‹¤ìŒ ë‹¬ í¬í•¨)
            const endDate = new Date(lastDay);
            endDate.setDate(endDate.getDate() + (6 - lastDay.getDay()));

            // ì´ë²ˆ ë‹¬ ì§€ì¶œë§Œ í•„í„°ë§í•˜ì—¬ ì›”ë³„ ì´ ì§€ì¶œ ê³„ì‚°
            const monthlyExpenses = dailyExpenses.filter(expense => {
                const expenseDate = new Date(expense.date + 'T00:00:00');
                return expenseDate.getFullYear() === year && expenseDate.getMonth() === month;
            });

            const expenses = monthlyExpenses.filter(e => e.type !== 'income');
            const incomes = monthlyExpenses.filter(e => e.type === 'income');

            const monthlyRegular = expenses
                .filter(e => (e.paymentMethod || 'regular') === 'regular')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const monthlyCrypto = expenses
                .filter(e => e.paymentMethod === 'crypto')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const monthlyIncome = incomes.reduce((sum, e) => sum + e.amount, 0);
            const monthlyNet = monthlyRegular + monthlyCrypto - monthlyIncome;

            // ì›”ë³„ ì´ ì§€ì¶œ í‘œì‹œ
            document.getElementById('monthlyRegularTotal').textContent = formatCurrency(monthlyRegular);
            document.getElementById('monthlyCryptoTotal').textContent = formatCurrency(monthlyCrypto);
            document.getElementById('monthlyIncome').textContent = formatCurrency(monthlyIncome);
            document.getElementById('monthlyNet').textContent = formatCurrency(monthlyNet);

            // ë‚ ì§œë³„ ì§€ì¶œ ë°ì´í„° ì •ë¦¬
            const expensesByDate = {};
            dailyExpenses.forEach(expense => {
                if (!expensesByDate[expense.date]) {
                    expensesByDate[expense.date] = {regular: [], crypto: [], income: []};
                }
                if (expense.type === 'income') {
                    expensesByDate[expense.date].income.push(expense);
                } else {
                    const paymentType = expense.paymentMethod || 'regular';
                    expensesByDate[expense.date][paymentType].push(expense);
                }
            });

            // ë‹¬ë ¥ ê·¸ë¦¬ê¸°
            const calendarDays = document.getElementById('calendarDays');
            let html = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = formatDateLocal(today);

            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const dateStr = formatDateLocal(currentDate);
                const isOtherMonth = currentDate.getMonth() !== month;
                const isToday = dateStr === todayStr;
                
                const dayExpenses = expensesByDate[dateStr] || {regular: [], crypto: [], income: []};
                const regularTotal = dayExpenses.regular.reduce((sum, e) => sum + e.amount, 0);
                const cryptoTotal = dayExpenses.crypto.reduce((sum, e) => sum + e.amount, 0);
                const incomeTotal = dayExpenses.income.reduce((sum, e) => sum + e.amount, 0);
                const totalCount = dayExpenses.regular.length + dayExpenses.crypto.length + dayExpenses.income.length;
                
                let dayClass = 'calendar-day';
                if (isOtherMonth) dayClass += ' other-month';
                if (isToday) dayClass += ' today';

                let expenseHtml = '';
                if (regularTotal > 0) {
                    expenseHtml += `<div class="calendar-day-expense">ğŸ’³ ${formatCurrency(regularTotal)}</div>`;
                }
                if (cryptoTotal > 0) {
                    expenseHtml += `<div class="calendar-day-expense" style="font-size: 11px;">ğŸª™ ${formatCurrency(cryptoTotal)}</div>`;
                }
                if (incomeTotal > 0) {
                    expenseHtml += `<div class="calendar-day-expense" style="font-size: 11px; color: #28a745;">ğŸ’° +${formatCurrency(incomeTotal)}</div>`;
                }
                if (totalCount > 0) {
                    expenseHtml += `<div class="calendar-day-items">${totalCount}ê±´</div>`;
                }

                html += `
                    <div class="${dayClass}" onclick="showDateDetails('${dateStr}')">
                        <div class="calendar-day-number">${currentDate.getDate()}</div>
                        ${expenseHtml}
                    </div>
                `;

                currentDate.setDate(currentDate.getDate() + 1);
            }

            calendarDays.innerHTML = html;
        }

        // ë¡œì»¬ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ì‹œê°„ëŒ€ ë¬¸ì œ ë°©ì§€)
        function formatDateLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ë‚ ì§œë³„ ìƒì„¸ ë‚´ì—­ ëª¨ë‹¬ ì—´ê¸°
        function showDateDetails(dateStr) {
            const dayExpenses = dailyExpenses.filter(e => e.date === dateStr);
            
            if (dayExpenses.length === 0) {
                return; // ì§€ì¶œì´ ì—†ìœ¼ë©´ ëª¨ë‹¬ì„ ì—´ì§€ ì•ŠìŒ
            }

            // ë‚ ì§œ í¬ë§·íŒ… (ì‹œê°„ëŒ€ ë¬¸ì œ ë°©ì§€)
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const weekday = weekdays[date.getDay()];
            
            document.getElementById('modalDate').textContent = `${year}ë…„ ${month}ì›” ${day}ì¼ (${weekday})`;

            // ì§€ì¶œê³¼ ìˆ˜ì… ë¶„ë¦¬
            const expenses = dayExpenses.filter(e => e.type !== 'income');
            const incomes = dayExpenses.filter(e => e.type === 'income');
            
            // ê²°ì œ ìˆ˜ë‹¨ë³„ë¡œ ë¶„ë¦¬
            const regularExpenses = expenses.filter(e => (e.paymentMethod || 'regular') === 'regular');
            const cryptoExpenses = expenses.filter(e => e.paymentMethod === 'crypto');

            let html = '';

            // ì¼ë°˜ì¹´ë“œ ì§€ì¶œ
            if (regularExpenses.length > 0) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="margin-bottom: 10px; color: #495057; font-size: 14px;">ğŸ’³ ì¼ë°˜ì¹´ë“œ</h4>';
                regularExpenses.forEach(expense => {
                    html += `
                        <div class="modal-expense-item">
                            <div class="modal-expense-info">
                                <div class="modal-expense-name">${expense.name}</div>
                            </div>
                            <div class="modal-expense-amount">${formatCurrency(expense.amount)}</div>
                        </div>
                    `;
                });
                const regularTotal = regularExpenses.reduce((sum, e) => sum + e.amount, 0);
                html += `<div style="text-align: right; padding: 10px 0; font-weight: 600; color: #495057;">ì†Œê³„: ${formatCurrency(regularTotal)}</div>`;
                html += '</div>';
            }

            // ê°€ìƒí™”íì¹´ë“œ ì§€ì¶œ
            if (cryptoExpenses.length > 0) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="margin-bottom: 10px; color: #495057; font-size: 14px;">ğŸª™ ê°€ìƒí™”íì¹´ë“œ</h4>';
                cryptoExpenses.forEach(expense => {
                    html += `
                        <div class="modal-expense-item">
                            <div class="modal-expense-info">
                                <div class="modal-expense-name">${expense.name}</div>
                            </div>
                            <div class="modal-expense-amount">${formatCurrency(expense.amount)}</div>
                        </div>
                    `;
                });
                const cryptoTotal = cryptoExpenses.reduce((sum, e) => sum + e.amount, 0);
                html += `<div style="text-align: right; padding: 10px 0; font-weight: 600; color: #495057;">ì†Œê³„: ${formatCurrency(cryptoTotal)}</div>`;
                html += '</div>';
            }

            // ìˆ˜ì…
            if (incomes.length > 0) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="margin-bottom: 10px; color: #28a745; font-size: 14px;">ğŸ’° ìˆ˜ì…</h4>';
                incomes.forEach(income => {
                    html += `
                        <div class="modal-expense-item">
                            <div class="modal-expense-info">
                                <div class="modal-expense-name">${income.name}</div>
                            </div>
                            <div class="modal-expense-amount" style="color: #28a745;">+${formatCurrency(income.amount)}</div>
                        </div>
                    `;
                });
                const incomeTotal = incomes.reduce((sum, e) => sum + e.amount, 0);
                html += `<div style="text-align: right; padding: 10px 0; font-weight: 600; color: #28a745;">ì†Œê³„: +${formatCurrency(incomeTotal)}</div>`;
                html += '</div>';
            }

            // ì´í•©
            const totalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
            const totalIncome = incomes.reduce((sum, e) => sum + e.amount, 0);
            const netAmount = totalExpense - totalIncome;
            
            html += `
                <div class="modal-total">
                    <span>ìˆœ ì§€ì¶œ</span>
                    <span>${formatCurrency(netAmount)}</span>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('dateModal').classList.add('active');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal(event) {
            if (!event || event.target.id === 'dateModal') {
                document.getElementById('dateModal').classList.remove('active');
            }
        }

        // ì¼ë³„ì§€ì¶œ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function editDailyExpense(id) {
            const expense = dailyExpenses.find(e => e.id === id);
            if (!expense) return;

            editingExpenseId = id;
            
            const transactionType = expense.type || 'expense';
            document.getElementById('editTransactionType').value = transactionType;
            document.getElementById('editDate').value = expense.date;
            document.getElementById('editName').value = expense.name;
            document.getElementById('editAmount').value = expense.amount;
            document.getElementById('editCategory').value = expense.category || 'ê¸°íƒ€';
            document.getElementById('editFromAccount').value = expense.fromAccountId || '';
            
            if (transactionType === 'expense') {
                document.getElementById('editPaymentMethod').value = expense.paymentMethod || 'regular';
            }
            
            updateEditPaymentMethodOptions();
            document.getElementById('editModal').classList.add('active');
        }

        // ìˆ˜ì • ëª¨ë‹¬ì˜ ê²°ì œ ìˆ˜ë‹¨ í‘œì‹œ/ìˆ¨ê¹€
        function updateEditPaymentMethodOptions() {
            const transactionType = document.getElementById('editTransactionType').value;
            const paymentMethodGroup = document.getElementById('editPaymentMethodGroup');
            
            if (transactionType === 'income') {
                paymentMethodGroup.style.display = 'none';
            } else {
                paymentMethodGroup.style.display = 'block';
            }
        }

        // ìˆ˜ì • ì €ì¥
        function saveEdit() {
            const transactionType = document.getElementById('editTransactionType').value;
            const date = document.getElementById('editDate').value;
            const name = document.getElementById('editName').value;
            const amount = parseFloat(document.getElementById('editAmount').value);
            const category = document.getElementById('editCategory').value;
            const paymentMethod = transactionType === 'income' ? 'income' : document.getElementById('editPaymentMethod').value;
            const newFromAccountId = document.getElementById('editFromAccount').value;

            if (!date || !name || !amount) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const expenseIndex = dailyExpenses.findIndex(e => e.id === editingExpenseId);
            if (expenseIndex !== -1) {
                const oldExpense = dailyExpenses[expenseIndex];
                
                // ì´ì „ ê³„ì¢Œë¡œ ê¸ˆì•¡ ë³µì›
                if (oldExpense.fromAccountId) {
                    const oldAccount = assets.find(a => a.id === oldExpense.fromAccountId);
                    if (oldAccount) {
                        if (oldExpense.type === 'expense') {
                            oldAccount.amount += oldExpense.amount;
                        } else {
                            oldAccount.amount -= oldExpense.amount;
                        }
                    }
                }
                
                // ìƒˆ ê³„ì¢Œì—ì„œ ì°¨ê°/ì…ê¸ˆ
                if (newFromAccountId) {
                    const newAccount = assets.find(a => a.id === parseInt(newFromAccountId));
                    if (newAccount) {
                        if (transactionType === 'expense') {
                            newAccount.amount -= amount;
                        } else {
                            newAccount.amount += amount;
                        }
                        newAccount.updatedAt = new Date().toISOString();
                    }
                }
                
                dailyExpenses[expenseIndex] = {
                    ...dailyExpenses[expenseIndex],
                    date: date,
                    name: name,
                    amount: amount,
                    paymentMethod: paymentMethod,
                    type: transactionType,
                    category: category,
                    fromAccountId: newFromAccountId ? parseInt(newFromAccountId) : null
                };

                saveData();
                updateDisplay();
                renderDailyList();
                renderAssetsList(); // ìì‚° ëª©ë¡ë„ ì—…ë°ì´íŠ¸
                
                if (currentView === 'calendar') {
                    renderCalendar();
                }

                closeEditModal();
                alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        // ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
        function closeEditModal(event) {
            if (!event || event.target.id === 'editModal') {
                document.getElementById('editModal').classList.remove('active');
                editingExpenseId = null;
            }
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeEditModal();
            }
        });

        // ë°ì´í„° ë‚´ë³´ë‚´ê¸° (JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ)
        function exportData() {
            const data = {
                salaries: salaries,
                fixedExpenses: fixedExpenses,
                dailyExpenses: dailyExpenses,
                customCategories: customCategories,
                assets: assets,
                exportDate: new Date().toISOString(),
                version: '2.0' // ë²„ì „ ì¶”ê°€
            };

            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `budget-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤!');
        }

        // ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (JSON íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°)
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                    if (!data.salaries && !data.fixedExpenses && !data.dailyExpenses && !data.assets) {
                        alert('ì˜¬ë°”ë¥¸ ê°€ê³„ë¶€ ë°ì´í„° íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
                        return;
                    }

                    // ë°ì´í„° ë³‘í•© ì—¬ë¶€ í™•ì¸
                    if (salaries.length > 0 || fixedExpenses.length > 0 || dailyExpenses.length > 0 || assets.length > 0 || customCategories.length > 0) {
                        const merge = confirm('ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ê³  ìƒˆ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní™•ì¸: ë°ì´í„° ë³‘í•©\nì·¨ì†Œ: ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í›„ ê°€ì ¸ì˜¤ê¸°');
                        
                        if (merge) {
                            // ë°ì´í„° ë³‘í•©
                            salaries = [...salaries, ...(data.salaries || [])];
                            fixedExpenses = [...fixedExpenses, ...(data.fixedExpenses || [])];
                            dailyExpenses = [...dailyExpenses, ...(data.dailyExpenses || [])];
                            customCategories = [...customCategories, ...(data.customCategories || [])];
                            assets = [...assets, ...(data.assets || [])];
                        } else {
                            // ë°ì´í„° êµì²´
                            salaries = data.salaries || [];
                            fixedExpenses = data.fixedExpenses || [];
                            dailyExpenses = data.dailyExpenses || [];
                            customCategories = data.customCategories || [];
                            assets = data.assets || [];
                        }
                    } else {
                        // ê¸°ì¡´ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ê°€ì ¸ì˜¤ê¸°
                        salaries = data.salaries || [];
                        fixedExpenses = data.fixedExpenses || [];
                        dailyExpenses = data.dailyExpenses || [];
                        customCategories = data.customCategories || [];
                        assets = data.assets || [];
                    }

                    // ì›”ê¸‰ ë‚ ì§œìˆœ ì •ë ¬
                    salaries.sort((a, b) => b.month.localeCompare(a.month));

                    saveData();
                    updateDisplay();
                    renderSalaryList();
                    renderFixedList();
                    renderDailyList();
                    renderAssetsList();
                    renderCustomCategoryList();
                    updateAllCategorySelects();
                    updateAccountDropdowns();
                    
                    if (currentView === 'calendar') {
                        renderCalendar();
                    }

                    alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!');
                } catch (error) {
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            
            // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡)
            event.target.value = '';
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageUpload({ target: { files: files } });
                }
            });
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // ì´ë¯¸ì§€ íŒŒì¼ í™•ì¸
            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('previewImage');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // ë¡œë”© í‘œì‹œ
            document.getElementById('loading').classList.add('active');

            try {
                // ì´ë¯¸ì§€ë¥¼ base64ë¡œ ë³€í™˜
                const base64 = await fileToBase64(file);
                
                // Claude APIë¡œ ì´ë¯¸ì§€ ë¶„ì„
                const expenses = await analyzeImageWithClaude(base64, file.type);
                
                // ë¶„ì„ëœ ë‚´ì—­ ì¶”ê°€
                if (expenses && expenses.length > 0) {
                    let addedCount = 0;
                    expenses.forEach(expense => {
                        if (expense.name && expense.amount && expense.amount > 0) {
                            fixedExpenses.push({
                                id: Date.now() + addedCount,
                                name: expense.name,
                                amount: expense.amount
                            });
                            addedCount++;
                        }
                    });

                    if (addedCount > 0) {
                        saveData();
                        updateDisplay();
                        renderFixedList();
                        alert(`${addedCount}ê°œì˜ ê³ ì •ì§€ì¶œ í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    } else {
                        alert('ìœ íš¨í•œ ì§€ì¶œ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } else {
                    alert('ì´ë¯¸ì§€ì—ì„œ ì§€ì¶œ ë‚´ì—­ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì´ë¯¸ì§€ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                // ë¡œë”© ìˆ¨ê¸°ê¸°
                document.getElementById('loading').classList.remove('active');
                // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
                event.target.value = '';
            }
        }

        // íŒŒì¼ì„ base64ë¡œ ë³€í™˜
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Claude APIë¡œ ì´ë¯¸ì§€ ë¶„ì„
        async function analyzeImageWithClaude(base64Image, mimeType) {
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'image',
                                        source: {
                                            type: 'base64',
                                            media_type: mimeType,
                                            data: base64Image
                                        }
                                    },
                                    {
                                        type: 'text',
                                        text: `ì´ ì´ë¯¸ì§€ì—ì„œ ê³ ì •ì§€ì¶œ í•­ëª©ë“¤ì„ ì°¾ì•„ì„œ JSON í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œí•´ì£¼ì„¸ìš”. 
                                        
ì‘ë‹µì€ ë°˜ë“œì‹œ JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ì„±í•˜ê³ , ë‹¤ë¥¸ ì„¤ëª…ì€ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
ê¸ˆì•¡ì—ì„œ ì‰¼í‘œë‚˜ í†µí™” ê¸°í˜¸ëŠ” ì œê±°í•˜ê³  ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš”.

í˜•ì‹:
[
  {"name": "í•­ëª©ëª…", "amount": ê¸ˆì•¡},
  {"name": "í•­ëª©ëª…", "amount": ê¸ˆì•¡}
]

ì˜ˆì‹œ:
[
  {"name": "ì›”ì„¸", "amount": 800},
  {"name": "ì „ê¸°ì„¸", "amount": 50}
]`
                                    }
                                ]
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error('API ìš”ì²­ ì‹¤íŒ¨');
                }

                const data = await response.json();
                const textContent = data.content.find(item => item.type === 'text')?.text || '';
                
                // JSON íŒŒì‹±
                const jsonMatch = textContent.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    const expenses = JSON.parse(jsonMatch[0]);
                    return expenses;
                }
                
                return [];
            } catch (error) {
                console.error('Claude API Error:', error);
                throw error;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        loadData();

        // ì¹´í…Œê³ ë¦¬ë³„ í†µê³„ ë Œë”ë§
        function renderCategoryStats() {
            const year = currentViewMonth.getFullYear();
            const month = currentViewMonth.getMonth();
            
            // í•´ë‹¹ ì›”ì˜ ì§€ì¶œë§Œ ê°€ì ¸ì˜¤ê¸° (ìˆ˜ì… ì œì™¸)
            const monthlyExpenses = getMonthlyExpenses(year, month).filter(e => e.type !== 'income');
            
            // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
            const categoryTotals = {};
            monthlyExpenses.forEach(expense => {
                const category = expense.category || 'ê¸°íƒ€';
                if (!categoryTotals[category]) {
                    categoryTotals[category] = 0;
                }
                categoryTotals[category] += expense.amount;
            });

            // ì´ ì§€ì¶œ ê³„ì‚°
            const totalExpense = Object.values(categoryTotals).reduce((sum, amount) => sum + amount, 0);

            const statsContainer = document.getElementById('categoryStats');
            
            if (totalExpense === 0) {
                statsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <p>ì´ë²ˆ ë‹¬ ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            // ê¸ˆì•¡ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);

            let html = '<div style="margin-top: 15px;">';
            sortedCategories.forEach(([category, amount]) => {
                const percentage = (amount / totalExpense * 100).toFixed(1);
                const emoji = getCategoryEmoji(category);
                
                html += `
                    <div class="category-stats-item" onclick="showCategoryDetails('${category}')">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #212529;">${emoji} ${category}</span>
                            <div style="text-align: right;">
                                <span style="font-weight: bold; color: #212529; margin-right: 10px;">${formatCurrency(amount)}</span>
                                <span style="color: #6c757d; font-size: 14px;">${percentage}%</span>
                            </div>
                        </div>
                        <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            statsContainer.innerHTML = html;
        }

        // ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸ ë‚´ì—­ ëª¨ë‹¬ í‘œì‹œ
        function showCategoryDetails(categoryName) {
            const year = currentViewMonth.getFullYear();
            const month = currentViewMonth.getMonth();
            
            // í•´ë‹¹ ì›”ì˜ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ì§€ì¶œë§Œ ê°€ì ¸ì˜¤ê¸°
            const categoryExpenses = getMonthlyExpenses(year, month).filter(e => 
                e.type !== 'income' && e.category === categoryName
            );

            if (categoryExpenses.length === 0) {
                alert('í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
            const sorted = [...categoryExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const emoji = getCategoryEmoji(categoryName);
            const total = categoryExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            document.getElementById('modalDate').textContent = `${emoji} ${categoryName} (${categoryExpenses.length}ê±´)`;

            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            
            sorted.forEach(expense => {
                const paymentBadge = expense.paymentMethod === 'crypto' 
                    ? '<span class="payment-badge crypto">ğŸª™ ê°€ìƒí™”í</span>'
                    : '<span class="payment-badge regular">ğŸ’³ ì¼ë°˜</span>';
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #212529; margin-bottom: 4px;">${expense.name} ${paymentBadge}</div>
                            <div style="font-size: 13px; color: #6c757d;">${expense.date}</div>
                        </div>
                        <div style="font-weight: bold; color: #212529; white-space: nowrap; margin-left: 15px;">
                            ${formatCurrency(expense.amount)}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            html += `
                <div class="modal-total">
                    <span>ì´ ì§€ì¶œ</span>
                    <span>${formatCurrency(total)}</span>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('dateModal').classList.add('active');
        }
    </script>
</body>
</html>
